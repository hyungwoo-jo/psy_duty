<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PSY 당직표</title>
    <link rel="icon" href="data:," />
    <link rel="stylesheet" href="assets/styles.css" />
  </head>
  <body>
    <header>
      <h1>PSY 당직표</h1>
    </header>

    <section class="controls">
      <div class="field">
        <label for="start-date">시작일</label>
        <input id="start-date" type="date" />
      </div>
      <div class="field">
        <label for="end-date">종료일</label>
        <input id="end-date" type="date" />
      </div>
      <div class="field">
        <label for="weeks">주 수(종료일 미지정 시)</label>
        <input id="weeks" type="number" min="1" max="8" value="4" />
      </div>
      <div class="field">
        <label for="retry-attempts">재시도 횟수</label>
        <input id="retry-attempts" type="number" min="1" value="100" />
      </div>
      
      <!-- 당직 인원 고정: 병당 1, 응당 1 (UI 옵션 제거) -->
      <div class="field field--full">
        <label for="employees">근무자 목록</label>
        <textarea id="employees" rows="12" placeholder="형식 예시:
R1 장주만
R1 조형우
R2 김대근
R2 김진아
R2 이수연
R3 권지영, 소아
R3 김선민
R3 윤준성
R4 김지영
R4 김현태
R4 이동인"></textarea>
      </div>
      <script>
        // 초기 기본 근무자: 고정 12인 + 연차 라벨(R1~R4)
        window.addEventListener('DOMContentLoaded', () => {
          const el = document.querySelector('#employees');
          if (el) el.value = [
            'R1 윤성민',
            'R1 장주만',
            'R1 조형우',
            'R2 김대근',
            'R2 김진아',
            'R2 이수연',
            'R3 권지영, 소아',
            'R3 김선민',
            'R3 윤준성, 응급',
            'R4 김지영',
            'R4 김현태',
            'R4 이동인',
          ].join('\n');
        });
      </script>
      <div class="field field--full">
        <label for="holidays">공휴일 지정</label>
        <div style="display:flex; gap:8px; align-items:flex-start; flex-wrap: wrap;">
          <textarea id="holidays" rows="4" placeholder="예시:&#10;2025-01-01&#10;-2025-02-28 (빼기)"></textarea>
          <div style="display:flex; flex-direction: column; gap:6px;">
            <button type="button" id="load-kr-holidays">공휴일 불러오기</button>
            <button type="button" id="clear-holidays">공휴일 비우기</button>
          </div>
        </div>
      </div>
      <div class="field field--full">
        <label for="unavailable">당직 불가일</label>
        <textarea id="unavailable" rows="5" placeholder="예시:
장주만: 2025-01-07, 2025-01-15
조형우: 2025-01-10 | 2025-01-11
윤성민: 2025-01-04
"></textarea>
      </div>
      <div class="field field--full">
        <label for="dayoff-wish">Day-off 희망일(평일)</label>
        <textarea id="dayoff-wish" rows="4" placeholder="예시:&#10;장주만: 2025-01-09, 2025-01-23&#10;조형우: 2025-01-16"></textarea>
      </div>
      <div class="field field--full">
        <label for="vacations">휴가</label>
        <textarea id="vacations" rows="4" placeholder="예시:&#10;장주만: 2025-01-06~2025-01-12&#10;조형우: 2025-01-20~2025-01-22, 2025-02-03~2025-02-04"></textarea>
      </div>

      <div class="field field--full">
        <details>
          <summary>Ruleset</summary>
          <fieldset>
            <div class="checkbox-group">
              <div>
                <input type="checkbox" id="toggle-r1-cap" checked />
                <label for="toggle-r1-cap">R1 주당 당직 상한 (2회)</label>
                <small>휴가자가 없으면 평일 2회까지만 배치하며, 공휴일이나 비상 상황에서는 자동으로 추가 배정될 수 있습니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-r3-cap" checked />
                <label for="toggle-r3-cap">R3 주당 당직 한도 (평시 1회)</label>
                <small>R3는 한 주에 최소 1회 배치되며, 휴가자가 있는 주에는 최대 2회까지 허용합니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-r2-min" checked />
                <label for="toggle-r2-min">R2 주당 최소 1회 당직</label>
                <small>각 R2에게 주별로 최소 1회 이상의 당직을 배정합니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-r3-balance" checked />
                <label for="toggle-r3-balance">비소아 R3 듀오 균형</label>
                <small>소아과 태그가 없는 R3 두 명이 있다면 병당·응당·Day-off 횟수를 균등하게 맞춥니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-dayoff-wish" checked />
                <label for="toggle-dayoff-wish">Day-off 희망일 반영</label>
                <small>희망한 날짜를 Day-off로 확보할 수 있도록 전날에 당직을 배정합니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-r3-ped-wed" checked />
                <label for="toggle-r3-ped-wed">R3 소아과 수요일 금지</label>
                <small>소아과 태그가 있는 R3는 수요일에는 당직에 배치하지 않습니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-vacation-ban" checked />
                <label for="toggle-vacation-ban">휴가일 근무 금지</label>
                <small>휴가로 입력된 날짜에는 당직을 배치하지 않습니다.</small>
              </div>
              <div>
                <input type="checkbox" id="toggle-unavailable-ban" checked />
                <label for="toggle-unavailable-ban">당직 불가일 금지</label>
                <small>개인 불가일로 지정된 날짜에는 당직을 배치하지 않습니다.</small>
              </div>
            </div>
          </fieldset>
        </details>
      </div>

      <div class="field field--full">
        <details>
          <summary>Scoring</summary>
          <fieldset>
            <div class="checkbox-group">
              <div class="legend">연차 선택</div>
              <div class="score-tabs" id="score-class-tabs" role="tablist" aria-label="Scoring class">
                <button type="button" role="tab" aria-selected="true" aria-pressed="true" data-klass="R1">R1</button>
                <button type="button" role="tab" aria-selected="false" aria-pressed="false" data-klass="R2">R2</button>
                <button type="button" role="tab" aria-selected="false" aria-pressed="false" data-klass="R3">R3</button>
                <button type="button" role="tab" aria-selected="false" aria-pressed="false" data-klass="R4">R4</button>
              </div>
              <div id="score-class-indicator" class="legend">현재: R1</div>
              <div><label for="score-overtime-soft" title="주간 근무시간이 72시간을 초과하고 75시간 미만일 때, 1건당 부과되는 점수입니다.">시간 초과 (72-75h) 점수</label><input type="number" id="score-overtime-soft" value="1" step="0.5" /></div>
              <small>한 주 총 근무 시간이 72~75시간이면 여기서 지정한 페널티를 부과합니다.</small>
              <div><label for="score-overtime-hard" title="주간 근무시간이 75시간 이상일 때, 1건당 부과되는 점수입니다.">고도 시간 초과 (>=75h) 점수</label><input type="number" id="score-overtime-hard" value="2" step="0.5" /></div>
              <small>한 주에 75시간 이상 근무한 인원에게는 이 값만큼 추가 페널티가 부과됩니다.</small>
              <div><label for="score-under-40" title="주간 근무시간이 40시간 미만일 때, 1건당 부과되는 점수입니다.">40h 미만 근무 주 점수</label><input type="number" id="score-under-40" value="1" step="0.5" /></div>
              <small>주당 근무 시간이 40시간 아래로 떨어진 경우 균형을 맞추기 위한 페널티입니다.</small>
              <div><label for="score-dayoff-base" title="Day-off 편차가 1일일 때 부과되는 기본 점수입니다.">Day-off 편차 기본 점수</label><input type="number" id="score-dayoff-base" value="0.5" step="0.1" /></div>
              <small>연차 내 평균 대비 Day-off 편차가 1일 있을 때 적용되는 기본 페널티입니다.</small>
              <div><label for="score-dayoff-increment" title="Day-off 편차가 1일을 초과할 때 늘어나는 추가 점수입니다.">Day-off 편차 추가 점수</label><input type="number" id="score-dayoff-increment" value="1" step="0.1" /></div>
              <small>Day-off 편차가 2일 이상 벌어질 때마다 누적되는 추가 페널티입니다.</small>
              <div><label for="score-role-base" title="병당/응당 역할 횟수가 1회 어긋났을 때 부과되는 기본 점수입니다.">역할 편차 기본 점수</label><input type="number" id="score-role-base" value="1" step="0.1" /></div>
              <small>병당/응당 역할 횟수가 평균에서 1회 벗어났을 때 적용되는 기본 페널티입니다.</small>
              <div><label for="score-role-increment" title="역할 편차가 1회를 초과할 때 늘어나는 추가 점수입니다.">역할 편차 추가 점수</label><input type="number" id="score-role-increment" value="1" step="0.1" /></div>
              <small>역할 편차가 2회 이상 벌어질 때마다 누적되는 추가 페널티입니다.</small>
              <div><label for="score-gap2" title="당직-휴무-당직(OFF 하나 사이)로 반복될 때 부과되는 점수입니다.">OFF 하나 간격 반복(당직-휴무-당직) 페널티</label><input type="number" id="score-gap2" value="0.5" step="0.5" /></div>
              <small>전날 한 번 쉬고 다시 당직에 투입되는 패턴을 줄이고 싶을 때 사용합니다.</small>

            </div>
          </fieldset>
        </details>
      </div>
      <div class="field field--full">
        <label>전일 당직(시작일 전날): 월요일 시작 시 전날 일요일 당직자를 지정하세요</label>
        <div style="display:flex; gap:10px; flex-wrap: wrap; align-items: center;">
          <div>
            <div class="legend">전일 병당</div>
            <input id="prior-byung" type="text" placeholder="이름" />
          </div>
          <div>
            <div class="legend">전일 응당</div>
            <input id="prior-eung" type="text" placeholder="이름" />
          </div>
          <div class="legend">전날이 주말/공휴일이면 시작일은 Day-off(정규/당직 제외)로 처리됩니다.</div>
        </div>
      </div>
      <div class="field field--full">
        <label>전전일 당직(시작일 이틀 전): 예) 월요일 시작 시 전전날(토요일) 당직자를 지정하세요</label>
        <div style="display:flex; gap:10px; flex-wrap: wrap; align-items: center;">
          <div>
            <div class="legend">전전일 병당</div>
            <input id="prior2-byung" type="text" placeholder="이름" />
          </div>
          <div>
            <div class="legend">전전일 응당</div>
            <input id="prior2-eung" type="text" placeholder="이름" />
          </div>
          <div class="legend">당직-휴무-당직 패턴을 정확히 계산하기 위해 전전일 당직자 정보를 활용합니다.</div>
        </div>
      </div>
      <div class="field">
        <label for="ics-version">ICS 버전명(예: v3)</label>
        <input id="ics-version" type="text" placeholder="v1" />
      </div>
      <div class="field" style="min-width: 380px;">
        <label>ICS 링크 기준 경로(자동)</label>
        <div id="ics-preview" class="legend">시작/종료일과 버전으로 자동 계산됩니다.</div>
        <div class="legend">필요 시 URL 쿼리 ?ics_base=... 로 강제 지정 가능</div>
      </div>
      <div class="field field--full">
        <label>지난달 반영</label>
        <div id="prev-stats-ui"></div>
      </div>

      <div class="field field--toggle">
        <label for="toggle-diagnostics" class="toggle-switch">
          <input type="checkbox" id="toggle-diagnostics">
          <span>diagnostics</span>
        </label>
      </div>
      <div class="actions">
        <button id="generate">당직표 생성</button>
        <button id="export-xlsx" disabled>Excel 내보내기</button>
        <button id="export-ics" disabled>ICS 내보내기</button>
      </div>
      <div id="messages" class="messages" aria-live="polite"></div>
    </section>

    <!-- 로딩 오버레이 -->
    <div id="loading-overlay" class="loading-overlay" aria-hidden="true">
      <div class="loading-box">
        <div class="spinner" aria-hidden="true"></div>
        <div class="loading-text">당직표 생성 중… 잠시만 기다려주세요</div>
      </div>
    </div>

    <section>
      <div id="summary" class="summary"></div>
      <div id="report" class="report"></div>
      <div class="legend">역할: 병당 1 · 응당 1 (매일). R3 소아턴은 수요일 당직 제외. R3 응급 태그 인원은 월간 응급 back.</div>
      <div id="roster" class="roster"></div>
    </section>

    <footer>
      <small>오픈소스 초안 — 정교화 필요 시 규칙/데이터 확장 가능</small>
    </footer>

    <script type="module" src="src/app.js"></script>
  </body>
  </html>
