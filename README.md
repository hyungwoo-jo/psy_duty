# PSY 당직표를 만들어보자. 

## 사용 방법
- 기간: 시작일 + (종료일 또는 주 수)
- 근무자 목록: `R연차 이름[, 소아][, 응급]`
- 공휴일: YYYY-MM-DD(줄당 1개), `-YYYY-MM-DD`로 제외
- 개인 불가일: `이름: YYYY-MM-DD, YYYY-MM-DD ...`
- 휴가: `이름: YYYY-MM-DD, ...` → 해당 날짜가 속한 주 전체 제외
- 이전 보정(Stat-to-Pass 입력): 각 사람별 병당/응당/Day-off에 대해 −5..+5
- 생성 → 요약/통계/보정치/당직표 확인 → Excel(.xls) 내보내기(ICS 링크 포함)

## 규칙(핵심)
- 1일 2명: 병당 1, 응당 1 (주말/공휴일 2명, 21h/인)
- 평일 당직 13.5h/인(정규 8h 포함). 다음날 정규 면제(Day-off)
- 주간 상한: 소프트 72h. 자동 재시도 트리거는 70h(최대 5회 재생성)
- 역할/연차 매핑 고정. 응급 back: R3 중 ‘응급’ 태그 1명 고정
- 연차별 당직 슬롯 고정된 형태

### 개인 불가일 처리: 중요! 
- 주말/공휴일 불가일: 그 날 당직 배제
- 평일 불가일: 그 날 당직/정규 제외 + 전날 당직 “강한 선호”를 부여(가능하면 전날 당직으로 해당 평일 Day-off 부여)
- 연차/역할 제약 상 특정 요일만 당직 가능한 경우, 불가일이 무의미할 수 있음(제약 우선) ex.4년차가 목요일을 불가일로 지정할 수는 없음

### 통계/보정치
- 주별 시간 통계(연차 내), 개인별 통계(병당/응당/총당직/Day-off/시간)
- Stat-to-Pass(다음달 보정치): 연차·역할별 여러 명에게 +/− 분배. 이전 보정은 사람/역할별로 먼저 합산 후 재계산
- 병당/응당은 역할별 독립 균형(평균의 floor/ceil). Day-off는 낮은 사람부터 끌어올리는 평균 분배
- 수련시간의 경우 평일과 주말이 21 21.5 시간으로 차이 나기는 하지만 실 근무에는 큰 차이가 없다 판단 
- 따라서 응당/병당 갯수와 day-off 숫자만 맞추면 수련시간은 자동으로 맞춰지게 됨 



### 공휴일
- 버튼으로 대한민국 공휴일(기간 내) 불러오기. 
- 텍스트에서 제외와 추가 가능

### 내보내기
- Excel(.xls): 색상/강조 포함 + 추가 시트 ‘ICS Links’에서 인원별 ICS 링크 제공
  - 주의: 보안 정책상 Excel에서 data: URL은 차단됩니다. 링크가 동작하려면 ‘ICS 링크 기본 경로’를 앱에서 설정하고, 해당 경로에 사람별 .ics 파일을 호스팅해야 합니다(아래 참고).
- ICS ZIP(옵션): 인원별 `이름.ics`를 ZIP으로 한 번에 다운로드

## ICS 내보내기 · 달력 추가 가이드

### 개요
- 앱에서 당직표 생성 후 ‘ICS 내보내기’를 누르면 `duty-roster-ics.zip`이 내려받아집니다.
- 압축을 풀면 인원별 `이름.ics`가 들어 있습니다(각 파일은 해당 인원의 당직일만 all‑day 이벤트로 포함; 응급 back 제외).
- 아래에서 사용하는 ‘가져오기/Import’는 보통 “기존 캘린더에 일정 합치기”를 의미합니다.

### Google Calendar(웹)
- 접속: https://calendar.google.com → 우상단 톱니바퀴 → 설정 → ‘가져오기/내보내기’ → ‘가져오기’
- 파일 선택: `이름.ics` 선택 → 넣을 캘린더 선택 → ‘가져오기’
- 동기화: 모바일 Google Calendar 앱과 자동 동기화됩니다.

### macOS 캘린더(Apple Calendar)
- Finder에서 `이름.ics` 더블클릭 → ‘캘린더에 추가’ 창에서 캘린더 선택 → 확인
- 또는 캘린더 앱 열기 → 메뉴 ‘파일’ → ‘가져오기…’ → `이름.ics` 선택

### iPhone/iPad(iOS)
- 가장 안정적인 방법: Google 캘린더 웹에서 가져오기(위 절차) → iOS의 해당 구글 계정과 동기화
- 또는 iOS에서 `이름.ics` 파일을 ‘파일’ 앱/메일로 열기 → 공유 시트에서 ‘캘린더에 추가’(버전/앱에 따라 표시 달라질 수 있음)

### Android(구글 캘린더 앱)
- 권장: Google 캘린더 웹에서 `이름.ics`를 계정으로 가져오기(웹 → 앱 자동 동기화)
- 일부 기기/버전은 파일 앱에서 `이름.ics`를 열어 ‘캘린더에 추가’가 가능합니다(미지원 기기는 웹을 사용하세요).

### Outlook
- Outlook 데스크톱(Windows/Mac): 파일 → 열기 및 내보내기 → 가져오기/내보내기 → ‘iCalendar(.ics) 가져오기’ → `이름.ics`
- Outlook 웹: https://outlook.office.com/calendar → ‘캘린더 추가’ → ‘파일에서 업로드’ → `이름.ics` 업로드 → 대상 캘린더 선택

### 주의/팁
- ICS 이벤트는 종일(all‑day)로 추가됩니다(시간대 미설정). 필요 시 캘린더 앱에서 개별 수정 가능.
- 개인별로 캘린더를 구분하고 싶으면, 먼저 비어있는 보조 캘린더를 만들어 그 캘린더로 가져오세요.
- 중복 가져오기를 피하려면, 가져오기 전에 기존 동일 월의 이벤트를 확인/정리하세요.

## 여러 사용자가 쉽게 추가하는 베스트 프랙티스

상황에 따라 두 가지 접근을 권장합니다.

- 월별 일괄 가져오기(간단): 지금 구현된 ‘ICS ZIP’으로 한 번에 내려받아 각자 `이름.ics`를 가져옵니다. 빠르고 쉬우나, 일정 변경 시 재가져오기가 필요합니다(구독 아님).
- 사람별 URL 공유(추천): 각 사람의 .ics 파일을 페이지에 호스팅해 ‘URL로 캘린더 추가(구독)’를 안내합니다. 일정이 바뀌면 파일만 교체하면 모두 자동 반영됩니다.

### 사람별 URL을 만드는 방법(정적 Pages 기준)
1) 앱에서 JSON 내보내기로 `duty-roster.json` 저장
2) 아래 스크립트로 사람별 ICS 생성
   - 버전 디렉토리 권장: `scripts/release_ics.sh --month 2025-01 --version v3 --json duty-roster.json --set-latest`
   - 수동으로 하려면: `python3 scripts/build_ics.py duty-roster.json -o public/ics/2025-01/v3`
3) `public/ics/2025-01` 경로를 리포지토리에 포함시키고 배포(`scripts/deploy.sh`)
4) 사용자에게 URL 제공:
   - 예시: `https://<OWNER>.github.io/psy_duty/ics/2025-01/홍길동.ics`
   - Google 캘린더의 ‘URL로 캘린더 추가’에 위 주소를 입력(https 또는 webcal로 시작 가능)
5) 앱에서 ‘ICS 링크 기본 경로’를 버전 포함 경로로 설정하고(예: `https://<OWNER>.github.io/psy_duty/ics/2025-01/v3/`) Excel을 내보내면, ‘ICS Links’ 시트의 링크가 정상 동작합니다.

TIP: GitHub Pages에서 열람 중이면 앱이 기본 경로를 자동 제안합니다(예: `https://<OWNER>.github.io/psy_duty/ics/YYYY-MM/`).

### 재생성/수정 시 덮어쓰기 방지 전략(중요)
- 버전 디렉토리 사용: 월별 디렉토리 아래에 `v1`, `v2`, `v3`처럼 버전 하위 디렉토리를 두고, 확정판만 공유합니다.
- Excel의 “ICS 링크 기본 경로”도 해당 버전 경로를 사용합니다(예: `/ics/2025-10/v3/`). 그러면 v4를 만들어도 기존 링크는 v3를 가리킵니다.
- 최신 공개 버전을 바꾸고 싶을 때만 `scripts/release_ics.sh ... --set-latest`로 `index.html` 리다이렉트를 최신으로 갱신하세요(브라우징 편의용).
- 권한 관리: GitHub Pages의 파일은 리포에 커밋/푸시해야만 바뀝니다. 앱 페이지에서 ‘만들기’를 눌러도 서버에 올라가지 않으므로, 유지관리자만 릴리스 스크립트를 실행/배포하도록 운영하세요.

갱신/재생성 시 동작
- 앱에서 다시 생성 후 JSON→ICS를 동일 경로(예: `ics/2025-01/이름.ics`)에 덮어쓰면, 구독 중인 사용자에게 자동 반영됩니다.
- 캘린더 제공자별 새로고침 주기는 수시간~최대 24시간 정도 지연될 수 있습니다(예: Google Calendar는 대개 수시간 간격).
- 중복 방지: 이벤트 UID를 날짜+역할+이름 기반으로 안정적으로 생성하도록 구현되어 있어, 같은 URL을 구독한 사용자는 변경된 동일 이벤트가 덮어써집니다.

비고: GitHub Pages는 정적 호스팅이라 .ics 파일만 올려도 `text/calendar`로 서비스됩니다(파일 확장자 기반). 월이 바뀔 때마다 위 과정을 반복하세요.
