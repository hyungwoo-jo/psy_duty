# 스케줄링 로직 설명

이 문서는 당직 스케줄링 시스템이 어떤 흐름과 규칙에 따라 동작하는지 알기 쉽게 설명합니다.

## 개요

스케줄링 시스템의 핵심 목표는, 주어진 모든 규칙과 제약 조건을 만족하면서 모든 근무자에게 최대한 공평한 당직표를 작성하는 것입니다.

이 과정은 "매우 똑똑한 해결사"에게 복잡한 퍼즐을 푸는 것과 같습니다. 우리는 해결사에게 퍼즐의 모든 규칙(예: "A는 B 옆에 올 수 없다")과 목표(예: "모든 조각을 사용해야 한다")를 알려주고, 해결사는 그 규칙을 모두 지키는 최적의 해답을 찾아냅니다. 여기서 '해결사'의 역할을 하는 것이 **ILP(정수 선형 계획법) 솔버**입니다.

## 스케줄링 과정 흐름

스케줄은 다음과 같은 단계를 거쳐 생성됩니다.

1.  **입력 정보 준비:** 사용자가 입력한 시작 날짜, 근무 기간, 근무자 명단, 휴가/휴일 정보, 이전 달의 보정치 등을 시스템이 이해할 수 있는 데이터로 변환합니다.

2.  **규칙(제약 조건) 설정:** 아래 '주요 규칙' 섹션에 설명된 모든 규칙들을 수학적인 형태의 '제약 조건'으로 만듭니다. 예를 들어, "A 근무자는 특정 날에 휴가이므로 당직을 설 수 없다"와 같은 규칙이 포함됩니다.

3.  **ILP 문제 생성 및 해결:** 준비된 데이터와 제약 조건들을 ILP 솔버에게 전달합니다. 솔버는 이 모든 조건을 만족하는 최적의 당직 조합을 계산하여 찾아냅니다.

4.  **결과 생성 및 표시:** 솔버가 찾아낸 수학적인 해답을 사람이 보기 좋은 당직표, 주간 근무 시간 통계, 다음 달 보정치 등의 형태로 가공하여 화면에 보여줍니다.

## 주요 규칙 및 제약 조건

스케줄러는 다음과 같은 핵심 규칙들을 바탕으로 당직을 배정합니다.

### 1. 기본 배정 규칙
- **자격 요건:** 각 당직 슬롯(병당, 응당)에는 해당 날짜와 요일에 맞는 특정 연차(R1~R4)의 근무자만 배정될 수 있습니다.
- **휴가/휴일:** 휴가 또는 당직 불가로 설정된 날에는 해당 근무자에게 당직이 배정되지 않습니다.
- **연속 당직 금지:** 어떤 근무자도 이틀 연속으로 당직을 설 수 없습니다.

### 2. 근무 시간 및 공평성 규칙
- **주간 최대 근무 시간:** 모든 근무자의 주간 총 근무 시간(정규 근무 + 당직)은 72시간을 초과하지 않도록 합니다.
- **당직 횟수 분배:** 연차 내에서 모든 근무자가 최대한 비슷한 횟수의 당직(병당, 응당)을 서도록 분배합니다.
- **Day-off 분배:** 평일 당직 다음 날 주어지는 Day-off 횟수 또한 연차 내에서 최대한 공평하게 분배됩니다.
- **이전 달 보정치 적용:** 이전 달에 당직이나 Day-off가 많거나 적었던 것을 보정치로 입력받아, 이번 달 스케줄에 반영하여 여러 달에 걸쳐 공평함이 유지되도록 합니다.

### 3. 3년차(R3) 특별 규칙
- **주 1회 당직 제한:** 3년차는 **주 1회**를 초과하여 당직을 서지 않는 것을 원칙으로 합니다.
- **예외 상황 처리:**
    - 만약 3년차 근무자의 휴가로 인해 이 규칙을 도저히 지킬 수 없는 경우에만, 시스템은 이 규칙을 자동으로 완화하여 스케줄을 생성합니다.
    - 그 외의 경우에는 이 규칙이 **반드시** 지켜집니다. 규칙을 지킬 수 없으면 스케줄 생성이 실패하고 사용자에게 알려줍니다.
- **소아과 수요일 당직 제외:** 소아과 3년차는 수요일에 당직이 배정되지 않습니다.
- **짝수 인원 분배:** 소아과가 아닌 3년차가 2명일 경우, 두 근무자의 병당, 응당, Day-off 횟수가 서로 1회 이상 차이 나지 않도록 최대한 동일하게 맞춥니다.

## 최적화 및 재시도 로직

최초 스케줄이 생성된 후에도, 시스템은 더 나은 결과를 찾기 위해 여러 번의 재시도를 수행합니다.

- **초기 생성:** 먼저 위에서 설명한 모든 규칙(R3 주 1회 제한 포함)을 적용하여 첫 스케줄을 생성합니다.
- **실패 시 완화:** 만약 R3의 휴가 등으로 인해 규칙을 지킬 수 없어 첫 생성이 실패하면, R3 주 1회 제한 규칙만 완화하여 다시 시도합니다.
- **반복 최적화:** 생성이 성공하면, 시스템은 정해진 횟수(최대 50회)만큼 재시도를 반복하며 다음과 같은 목표를 달성하려고 노력합니다.
    1.  주간 근무시간 72시간 초과 최소화
    2.  연차 내 당직 횟수 편차 최소화
    3.  비어있는 당직 슬롯 최소화
- 이 과정에서 이전에 찾은 해보다 더 공평하고 규칙을 잘 지키는 해를 찾으면, 그것을 최종 결과로 선택합니다. 재시도 시에도 R3 주 1회 제한 규칙은 (가능한 경우) 계속 적용됩니다.
