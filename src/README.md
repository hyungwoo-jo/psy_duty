# `scheduler.js` ILP 모델 아키텍처

이 문서는 `scheduler.js`에서 사용되는 정수 선형 계획법(ILP) 모델의 제약 조건과 코드 구조를 설명합니다.

## 개요

이 스케줄링 모델은 복잡한 규칙들을 만족하는 유효한 해를 찾기 위해 ILP를 사용합니다. 모델의 핵심 목표는 최적의 "품질" 점수를 찾는 것이 아니라, 아래에 명시된 모든 **하드 제약 조건(Hard Constraint)**을 만족하는 실행 가능한 해를 찾는 것입니다. 즉, "가장 좋은 해"를 찾는 최적화 문제가 아닌, "규칙을 모두 지키는 해"를 찾는 제약 충족 문제입니다.

유일한 예외는 모든 슬롯을 반드시 채우도록 하는 제약으로, 이는 매우 높은 페널티를 부여하여 사실상 하드 제약 조건처럼 작동합니다.

## 하드 제약 조건

모델은 다음의 절대적인 규칙들을 모두 만족해야 합니다.

1.  **슬롯 충족**: 모든 당직 슬롯은 반드시 한 명의 근무자로 채워져야 합니다.

2.  **연속 근무 금지**: 한 사람이 연속된 날짜에 당직 근무를 할 수 없습니다.

3.  **주간 근무 시간 상한**: 모든 근무자의 주당 근무 시간은 72시간을 초과할 수 없습니다.

4.  **역할/연차 배정**: 각 당직 슬롯(날짜, 역할)에는 사전에 정의된 특정 연차의 레지던트만 배정될 수 있습니다.

5.  **당직 횟수 균형 (±1)**:
    *   **기본 규칙**: 3년차(R3)가 아닌 레지던트는 역할(병당/응당)별로 개인의 총 당직 횟수가 연차 내 평균에서 ±1 이내여야 합니다.
    *   **지난달 근무 반영 (Carryover)**: 이 `±1` 캡은 지난달의 근무 횟수 통계(carryover)를 반영하여 조정됩니다. 예를 들어, 지난달에 평균보다 근무를 1회 덜 했다면, 이번 달의 최대 근무 가능 횟수가 1회 늘어나는 방식으로 장기적인 균형을 맞춥니다. (`새로운 min/max = 기존 min/max - carryover`)
    *   **3년차(R3) 합산 캡**: 3년차 레지던트의 경우, '병당'과 '응당'을 따로 계산하지 않고, 두 역할의 **합산된 총 당직 횟수**가 `±1` 캡 규칙을 따릅니다.

6.  **휴무(Day-off) 희망일 보장**: 근무자가 특정 날짜 `D`에 Day-off를 희망하면, 모델은 반드시 그 전날인 `D-1`에 해당 근무자에게 당직을 배정합니다.

7.  **Day-off 횟수 균형 (±3)**: 3년차를 제외한 모든 근무자의 총 Day-off 횟수는 소속 그룹 내 평균에서 `±3` 이내여야 합니다.

8.  **3년차(R3) 그룹 내 특별 균형 규칙**:
    *   **Day-off 횟수 (±1)**: 3년차 그룹 내에서는 서로 간의 Day-off 횟수 차이가 1회를 초과할 수 없습니다.
    *   **소아턴 제외 2인 균형 (±1)**: 만약 소아턴이 아닌 3년차가 정확히 2명일 경우, 이 두 사람 간의 '병당', '응당', 'Day-off' 횟수는 각각 서로 1회 이상 차이 나지 않아야 합니다.

9.  **근무 불가일**: `dutyUnavailable` 또는 `vacationDays`로 지정된 날짜에는 당직이 배정되지 않습니다.

## 코드 구조

핵심 로직은 `scheduler.js` 내의 다음 함수들로 구성됩니다.

-   `generateSchedule(params)`: 모든 로직을 관장하는 메인 진입 함수입니다.
-   `prepareContext(params)`: 사용자의 입력을 받아 ILP 모델에 필요한 모든 데이터(기간, 근무자, 휴일, 제약 조건 등)를 준비하고 계산하는 역할을 합니다.
-   `buildModel(ctx)`: `prepareContext`에서 생성된 데이터를 바탕으로, 위에 설명된 모든 제약 조건을 정의하여 ILP 모델을 구축하는 핵심 함수입니다.
-   `buildResultFromSolution(...)`: ILP 솔버가 찾은 해를 사람이 읽을 수 있는 최종 스케줄 표와 통계 데이터로 가공합니다.
